tosca_definitions_version: alien_dsl_3_0_0

metadata:
  template_name: eflows4hpc.topologies.MinimalWorkflow
  template_version: 0.1.0-SNAPSHOT
  template_author: loicalbertin

description: ""

imports:
  - yorc-types:1.1.0
  - tosca-normative-types:1.0.0-ALIEN20
  - dls.ansible:1.0.0-SNAPSHOT
  - alien-base-types:3.0.0
  - pycomps.ansible:1.0.0-SNAPSHOT

topology_template:
  inputs:
    dls_api_username:
      type: string
      required: true
    dls_api_password:
      type: string
      required: true
  node_templates:
    DLSDAGRun:
      metadata:
        a4c_edit_x: 231
        a4c_edit_y: "-339"
      type: dls.ansible.nodes.DLSDAGRun
      properties:
        dls_api_url: "http://134.94.199.73:7001/api/v1"
        dls_api_username: { get_input: dls_api_username }
        dls_api_password: { get_input: dls_api_password }
        dag_id: "taskflow_example"
        oid: dba52935c7e444d198b377876b4fe0a8
        target_host: "amdlogin.bsc.es"
        target_path: "/home/bsc44/bsc44070/dls_transfert/data/"
    PyCOMPSJob:
      metadata:
        a4c_edit_x: 243
        a4c_edit_y: "-176"
      type: pycomps.ansible.nodes.PyCOMPSJob
      properties:
        pycomps_endpoint: "amdlogin.bsc.es"
        num_nodes: 2
        data_path: "/home/bsc44/bsc44070/dls_transfert/data/"
        command: "~/wordcount_blocks/src/wordcount_blocks.py"
        arguments:
          - "${DATA_PATH}/data.txt"
          - "${DATA_PATH}/result.txt"
          - 3000
      requirements:
        - dependsOnDlsdagRunFeature:
            type_requirement: dependency
            node: DLSDAGRun
            capability: tosca.capabilities.Node
            relationship: tosca.relationships.DependsOn
  workflows:
    exec_job:
      inputs:
        user_id:
          type: string
          required: true
        oid:
          type: string
          required: true
        target_path:
          type: string
          required: true
        num_nodes:
          type: integer
          required: false
          default: 1
      steps:
        DLSDAGRun_submit:
          target: DLSDAGRun
          operation_host: ORCHESTRATOR
          activities:
            - call_operation: tosca.interfaces.node.lifecycle.Runnable.submit
          on_success:
            - DLSDAGRun_submitted
        PyCOMPSJob_executed:
          target: PyCOMPSJob
          activities:
            - set_state: executed
        PyCOMPSJob_submitted:
          target: PyCOMPSJob
          activities:
            - set_state: submitted
          on_success:
            - PyCOMPSJob_executing
        DLSDAGRun_submitted:
          target: DLSDAGRun
          activities:
            - set_state: submitted
          on_success:
            - DLSDAGRun_executing
        PyCOMPSJob_submitting:
          target: PyCOMPSJob
          activities:
            - set_state: submitting
          on_success:
            - PyCOMPSJob_submit
        PyCOMPSJob_submit:
          target: PyCOMPSJob
          operation_host: ORCHESTRATOR
          activities:
            - call_operation: tosca.interfaces.node.lifecycle.Runnable.submit
          on_success:
            - PyCOMPSJob_submitted
        DLSDAGRun_submitting:
          target: DLSDAGRun
          activities:
            - set_state: submitting
          on_success:
            - DLSDAGRun_submit
        DLSDAGRun_executing:
          target: DLSDAGRun
          activities:
            - set_state: executing
          on_success:
            - DLSDAGRun_run
        DLSDAGRun_executed:
          target: DLSDAGRun
          activities:
            - set_state: executed
          on_success:
            - PyCOMPSJob_submitting
        PyCOMPSJob_run:
          target: PyCOMPSJob
          operation_host: ORCHESTRATOR
          activities:
            - call_operation: tosca.interfaces.node.lifecycle.Runnable.run
          on_success:
            - PyCOMPSJob_executed
        PyCOMPSJob_executing:
          target: PyCOMPSJob
          activities:
            - set_state: executing
          on_success:
            - PyCOMPSJob_run
        DLSDAGRun_run:
          target: DLSDAGRun
          operation_host: ORCHESTRATOR
          activities:
            - call_operation: tosca.interfaces.node.lifecycle.Runnable.run
          on_success:
            - DLSDAGRun_executed
